<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>PcAddAdapterDevice</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="PcAddAdapterDevice">
</HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_driver_object_kr">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_pdo_dg_gly">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_device_object_kr">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_adddevice_kr">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_adddevice_kr">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_fdo_dg_gly">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_adddevice_kr">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_driver_object_kr">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_device_object_kr">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Streaming&nbsp;Devices&nbsp;(Video&nbsp;and&nbsp;Audio):&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H1><A NAME="ddk_pcaddadapterdevice_ks"></A>PcAddAdapterDevice</H1>

<P>The <B>PcAddAdapterDevice</B> function adds an adapter device to the WDM device stack.</P>

<PRE class=syntax><B>PORTCLASSAPI NTSTATUS NTAPI
  PcAddAdapterDevice(
    IN PDRIVER_OBJECT  </B><I>DriverObject</I><B>,</B>
<B>    IN PDEVICE_OBJECT  </B><I>PhysicalDeviceObject</I><B>,</B>
<B>    IN PCPFNSTARTDEVICE  </B><I>StartDevice</I><B>,</B>
<B>    IN ULONG  </B><I>MaxObjects</I><B>,</B>
<B>    IN ULONG  </B><I>DeviceExtensionSize</I>
<B>    );</B></PRE>

<H4>Parameters</H4>

<DL>
<DT><I>DriverObject</I></DT>

<DD>Pointer to the driver object. This pointer is passed as a parameter to the adapter's <I>AddDevice</I> handler. The driver object is a system structure of type <A HREF="JavaScript:hhobj_1.Click()">DRIVER_OBJECT</A>.</DD>

<DT><I>PhysicalDeviceObject</I></DT>

<DD>Pointer to the device's <I>physical device object </I>(<A HREF="JavaScript:hhobj_2.Click()">PDO</A>). PortCls passes this pointer as a call parameter to the adapter's <I>AddDevice</I> handler. The PDO is a system structure of type <A HREF="JavaScript:hhobj_3.Click()">DEVICE_OBJECT</A>.</DD>

<DT><I>StartDevice</I></DT>

<DD>Pointer to the function that the operating system calls in order to start the device. See the following <B>Comments</B> section.</DD>

<DT><I>MaxObjects</I></DT>

<DD>Specifies the maximum number of subdevices to be registered by calls to <A HREF="audpc-routines_4n8z.htm"><B>PcRegisterSubdevice</B></A>. This count sets the upper limit to the total number of miniport objects that the adapter driver can instantiate.</DD>

<DT><I>DeviceExtensionSize</I></DT>

<DD>Specifies the device extension size. Use zero for default size. See the following <B>Comments</B> section for user-supplied extension sizes.
</DD>
</DL>

<H4>Return Value</H4>

<P><B>PcAddAdapterDevice</B> returns STATUS_SUCCESS if the call was successful. Otherwise, it returns an appropriate error code.</P>

<H4>Headers</H4>

<P>Declared in <I>portcls.h</I>. Include <I>portcls.h</I>.</P>

<H4>Comments</H4>

<P>This function does most of the work that the audio adapter driver's <A HREF="JavaScript:hhobj_4.Click()"><I>AddDevice</I></A><I> </I>handler needs to perform. <B>PcAddAdapterDevice</B> creates the device object, initializes the device context, and attaches the device object to the device stack.</P>

<P>An adapter driver calls <B>PcAddAdapterDevice</B> when it receives a call to its <I>AddDevice </I>handler (see <A HREF="JavaScript:hhobj_5.Click()"><I>AddDevice</I></A>). The <I>AddDevice </I>handler is typically installed in the device object by a call to <A HREF="audpc-routines_7xyr.htm"><B>PcInitializeAdapterDriver</B></A>, but it can also be installed by the adapter driver by other means. <B>PcAddAdapterDevice</B> creates the <I>functional device object </I>(<A HREF="JavaScript:hhobj_6.Click()">FDO</A>) for the PDO that was passed to the <I>AddDevice</I> handler.</P>

<P><I>DeviceExtensionSize</I> is typically zero. Some adapters may want to reserve additional space in the device extension, in which case they may specify a <I>DeviceExtensionSize</I> greater than PORT_CLASS_DEVICE_EXTENSION_SIZE, which is the default size. Any value greater than zero and less than PORT_CLASS_DEVICE_EXTENSION_SIZE is illegal. Adapters are free to use any part of the device extension after offset PORT_CLASS_DEVICE_EXTENSION_SIZE. They are also free to use bytes in the offset range of 16 to 31 inclusive. If the extension is regarded as an array of ULONGs, ULONGs four through seven are available for use by the adapter.</P>

<P>The <I>StartDevice</I> parameter points to a function of type PCPFNSTARTDEVICE, which header file <I>portcls.h </I>defines as:</P>

<PRE>  NTSTATUS
    (*PCPFNSTARTDEVICE)(
        IN  PDEVICE_OBJECT  DeviceObject,
        IN  PIRP            Irp,
        IN  PRESOURCELIST   ResourceList
        );</PRE>

<P>For more information on <B>PcAddAdapterDevice</B> and the adapter driver's device-startup and <I>AddDevice </I>routines, see <A HREF="pcdesign_92cn.htm">Startup Sequence</A>.</P>

<H4>Example</H4>

<P>The following example code shows how an adapter driver can use the <I>DeviceExtensionSize </I>parameter to append 64 bytes of device-specific extension data to the end of the storage block that PortCls allocates for the device context:</P>

<PRE>  #define MY_EXTENSION_SIZE 64
  NTSTATUS ntstatus = PcAddAdapterDevice(DriverObject,   PhysicalDeviceObject,
                                         MyStartDevice, MAX_MINIPORTS,
                                         MY_EXTENSION_SIZE + PORT_CLASS_DEVICE_EXTENSION_SIZE);</PRE>

<P>The <B>PcAddAdapterDevice</B> call above is similar to the example in <A HREF="pcdesign_92cn.htm">Startup Sequence</A>, except that the last parameter that is passed to <B>PcAddAdapterDevice</B> is nonzero.</P>

<P>The adapter driver can then access the device-specific extension data, as shown in the following code fragment:</P>

<PRE>  PDEVICE_CONTEXT pDeviceContext = (PDEVICE_CONTEXT)(FunctionalDeviceObject-&gt;DeviceExtension);
  PVOID pMyExtensionData = (PVOID)((PCHAR)pDeviceContext + PORT_CLASS_DEVICE_EXTENSION_SIZE);</PRE>

<P>Variable <I>FunctionalDeviceObject</I> is a pointer to the audio adapter's FDO, and <I>pMyExtensionData</I> is a temporary pointer to the extension data. Avoid confusing the FDO with the PDO, which belongs to the PCI bus driver. The adapter driver must not modify data in the PDO because doing so corrupts memory owned by the PCI bus driver and can cause the system to crash.</P>

<H4>See Also</H4>

<P><A HREF="JavaScript:hhobj_7.Click()"><I>AddDevice</I></A>, <A HREF="JavaScript:hhobj_8.Click()">DRIVER_OBJECT</A>, <A HREF="JavaScript:hhobj_9.Click()">DEVICE_OBJECT</A>, <A HREF="audpc-routines_4n8z.htm"><B>PcRegisterSubdevice</B></A> </P>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: PcAddAdapterDevice"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
