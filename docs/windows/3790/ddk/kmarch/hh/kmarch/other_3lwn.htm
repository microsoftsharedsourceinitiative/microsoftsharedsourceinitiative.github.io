<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>Defining Custom Error Types</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="Defining Custom Error Types">
<META NAME="MS-HKWD" CONTENT="Creating the Error Message Text File">
<META NAME="MS-HKWD" CONTENT="Compiling the Error Message Text File">
</HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_build_tools">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Kernel-Mode&nbsp;Driver&nbsp;Architecture:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H2><A NAME="ddk_defining_custom_error_types_kg"></A>Defining Custom Error Types</H2>

<P>Drivers can specify their own error types and error messages. To define a custom error message, you must first define a new IO_ERR_<I>XXX</I> value to specify as the <B>ErrorCode</B> member of the error log entry. The Event Viewer uses the IO_ERR_<I>XXX</I> value to look up the driver's error message.</P>

<P>To support custom error messages in your driver, follow these steps:

<OL>
	<LI>Create a message text file that specifies the custom IO_ERR_<I>XXX</I> value and the corresponding error messages. For further information, see <A HREF="#ddk_creating_the_error_message_text_file_kg">Creating the Error Message Text File</A>.</LI>

	<LI>Compile the error message text file to a resource, and attach the resource to the driver image. For further information, see <A HREF="#ddk_compiling_the_error_message_text_file_kg">Compiling the Error Message Text File</A>.</LI>

	<LI>Register the driver image as containing error messages. For further information, see <A HREF="other_8duv.htm">Registering as a Source of Error Messages</A>.</LI>
</OL>



<H3><A NAME="ddk_creating_the_error_message_text_file_kg"></A>Creating the Error Message Text File</H3>

<P>The definition of a driver's custom IO_ERR_<I>XXX</I> values and matching error message templates are attached as a message table resource to the driver image. You can describe the messages for a driver in a message text file (.mc). </P>

<P>A message text file consists of two sections:  a header section and a message section. The header section permits the declaration of symbolic names for numerical values, while the message section specifies the IO_ERR_<I>XXX</I> values and matching error message templates.</P>

<H4>Header Section</H4>

<P>The header section must contain this line:</P>

<PRE>MessageIdTypedef=NTSTATUS
</PRE>

<P>This ensures that the type of IO_ERR_<I>XXX</I> values generated by the Message Compiler is declared to be NTSTATUS.</P>

<P>The other directives that appear in the header section define symbolic values that are used in place of numeric values in the message section.</P>

<P>The <B>SeverityNames</B> and <B>FacilityNames</B> directives define symbolic values for the severity and facility fields of NTSTATUS values. The directives are of the form <I>keyword</I> <B>=</B> <B>(</B> <I>values</I> <B>)</B>, where <I>values</I> consists of one or more statements of the form <I>name </I><B>=</B> <I>value </I><B>:</B> <I>header_name</I>, separated by white space. The <I>name</I> parameter is the name you use the specify the numeric <I>value</I> in the message text file, while the <I>header_name</I> is the name for this value declared in the C header file generated by the Message Compiler. The :<I>header_name</I> clause is optional.</P>

<P>Here is an example of a header declaration of symbolic names for severity codes:</P>

<PRE>SeverityNames = (
  Success       = 0x0:STATUS_SEVERITY_SUCCESS
  Informational = 0x1:STATUS_SEVERITY_INFORMATIONAL
  Warning       = 0x2:STATUS_SEVERITY_WARNING
  Error         = 0x3:STATUS_SEVERITY_ERROR
)
</PRE>

<P>The <B>LanguageNames</B> directive defines symbolic values for locale IDs (LCID). The directive is of the form <B>LanguageNames</B> <B>=</B> <B>(</B> <I>values</I> <B>)</B>, where <I>values</I> consists of one or more statements of the form <I>language_name </I><B>=</B> <I>lcid </I><B>:</B> <I>langfile</I>, separated by white space. The <I>language_name</I> parameter is the name you use in place of <I>lcid</I> in the message text file, while the <I>filename</I> specifies a unique filename (without extension). When the Message Compiler generates the resource script from the message text file, it stores all of the string resources for this language in a file named <I>langfile</I>.<I>bin</I>.</P>

<H4>Message Section</H4>

<P>Each message definition begins with the definition of the custom IO_ERR_<I>XXX</I> value that the driver uses to report this particular type of error. The IO_ERR_<I>XXX</I> value is defined by a series of <I>keyword </I>= <I>value</I> pairs. The possible keywords and their meaning are as follows.</P>

<TABLE>

<TR VALIGN="top">
<TH align=left width=48%>Keyword</TH>
<TH align=left width=52%>Value</TH>
</TR>

<TR VALIGN="top">
<TD width=48%><B>MessageId</B></TD>
<TD width=52%>Code field of the new IO_ERR_<I>XXX</I> value.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>Severity</B></TD>
<TD width=52%>Severity field of the new IO_ERR_<I>XXX</I> value. The specified value must be one of the symbolic names defined by the <B>SeverityNames</B> header directive.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>Facility</B></TD>
<TD width=52%>Facility field of the new IO_ERR_XXX value. The specified value must be one of the symbolic names defined by the <B>FacilityNames</B> header directive.</TD>
</TR>

<TR VALIGN="top">
<TD width=48%><B>SymbolicName</B></TD>
<TD width=52%>The symbolic name for the new IO_ERR_<I>XXX</I> value. The Message Compiler generates a C header file that contains a <B>#define</B> declaration of the name as the corresponding NTSTATUS value. The driver uses that name when specifying the error type.</TD>
</TR>
</TABLE><BR>

<P>The first keyword must always be <B>MessageId</B>.</P>

<P>The rest of the message definition consists of one or more localized versions of the error message. Each version is of the form:</P>

<PRE><B>Language</B>=<I>language_name</I>
<I>localized_message</I></PRE>

<P>The <I>language_name</I> value, which must be one of the symbolic names defined by the <B>LanguageNames</B> header directive, specifies the language of the message text. The localized message text itself consists of a Unicode string. Any embedded strings of the form "%<I>n</I>" will be treated as templates that the Event Viewer will replace when the error is logged. The "%1" string is replaced with the name of the driver's device object, while "%2" through "%<I>n</I>" are replaced with any insertion strings provided by the driver.</P>

<P>The message definition is terminated by a single period alone on a line.</P>

<P>If you define custom error messages, you should not use insertion strings unless necessary. Insertion strings cannot be localized, so they should be used for strings that are language-independent, such as numbers or file names. Most drivers do not use insertion strings.</P>



<H3><A NAME="ddk_compiling_the_error_message_text_file_kg"></A>Compiling the Error Message Text File</H3>

<P>Use the Message Compiler (<I>mc.exe</I>) to compile your message text file into a resource script file (<I>.rc</I> ). A command of the form</P>

<PRE>mc <I>filename</I>.mc</PRE>

<P>causes the Message Compiler to generate the following files:

<UL>
	<LI><I>filename</I>.h, a header file that contains declarations of each custom IO_ERR_<I>XXX</I> value in <I>filename</I>.<I>mc</I>.</LI>

	<LI><I>filename</I>.rc, a resource script.</LI>

	<LI>One file for each language that appears in the message text file. Each of these files stores all of the error message string resources for one language. The file for each language is named <I>langfile</I>.<I>bin</I>, where <I>langfile</I> is the value specified for the language in the message text file's <B>LanguageNames</B> directive.</LI>
</UL>

<P>More information about the Message Compiler can be found in the Platform SDK.</P>

<P>The Resource Compiler converts a resource script to a resource file that you can attach to your driver image. If you use the Build utility to build your driver, you can make sure that the resource script is converted to a resource file and attached to your driver image simply by including the name of the resource script in the SOURCES variable for the driver. For more information about the Resource Compiler, see the Platform SDK documentation. For information about using the Build utility to build your driver, see <A HREF="JavaScript:hhobj_1.Click()">Build</A>.</P>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: Defining%20Custom%20Error%20Types"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
