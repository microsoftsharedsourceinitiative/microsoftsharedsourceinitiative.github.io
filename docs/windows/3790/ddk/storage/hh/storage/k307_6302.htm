<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>IOCTL_STORAGE_MCN_CONTROL</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="IOCTL_STORAGE_MCN_CONTROL">
</HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_io_stack_location_kr">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_io_stack_location_kr">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Storage&nbsp;Devices:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H1><A NAME="ddk_ioctl_storage_mcn_control_kr"></A>IOCTL_STORAGE_MCN_CONTROL</H1>

<H4>Operation</H4>

<P>Temporarily enables or disables delivery of the custom PnP events GUID_IO_MEDIA_ARRIVAL and GUID_IO_MEDIA_REMOVAL on a removable-media device. This, in turn, enables or disables media change detection (AutoPlay) for the device if the caller has opened the device with FILE_READ_ATTRIBUTES access and if the device has AutoPlay enabled in the registry. The caller must not open the device for read or write access or the IOCTL operation will fail. This IOCTL has no effect on the AutoPlay setting in the registry per se.</P>

<P>A driver for such a removable-media device must do the following:

<OL>
	<LI>Keep a count of disable requests, per physical device, in the device object extension.</LI>

	<LI>When called with this IOCTL, if the flag to disable media change detection is set, increment the count; if the flag is clear, decrement the count.</LI>

	<LI>Set the media change event for the device when the media state is changed only if the disable request count is zero.</LI>
</OL>

<P>When the IRP_MJ_DEVICE_CONTROL IRP that contains this IOCTL is passed to the SCSI class driver the <B>FileObject </B>member of the current <A HREF="JavaScript:hhobj_1.Click()">IO_STACK_LOCATION</A> must point to a valid file object. The SCSI class driver requires a file object for cases where a user-mode application that is disabling or enabling AutoPlay terminates unexpectedly. In such cases the SCSI class driver uses the file object to re-enable media change detection. Because the file object is necessary for proper clean-up, the SCSI class driver will cause the IRP to fail with an error message of STATUS_INVALID_PARAMETER if the <B>FileObject</B> member of IO_STACK_LOCATION does not point to a valid file object. If a user-mode application opens the device, then the I/O Manager initializes this member, but kernel-mode driver writers should not assume that <B>FileObject</B> will be properly initialized when the IRP is generated by a user-mode application. If, for instance, a user-mode application mistakenly opens the device for either read or write access before sending the IOCTL, then the device control IRP will be routed through the file system, preventing the SCSI class driver and the device driver from directly accessing the device's file object.  </P>

<H4>Input</H4>

<P>The buffer at <B>Irp-&gt;AssociatedIrp.SystemBuffer</B> contains a Boolean value, with TRUE indicating that the driver should disable media change detection.</P>

<H4>Output</H4>

<P>None</P>

<H4>I/O Status Block</H4>

<P>The <B>Information</B> field is set to zero. The <B>Status</B> field is set to STATUS_SUCCESS, or possibly to STATUS_BUFFER_TOO_SMALL, STATUS_INVALID_PARAMETER, or STATUS_INVALID_DEVICE_STATE.</P>

<H4>Headers</H4>

<P>Defined in <I>ntddstor.h</I>. Include <I>ntddstor.h</I>. </P>

<H4>See Also</H4>

<P><A HREF="JavaScript:hhobj_2.Click()">IO_STACK_LOCATION</A> </P>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: IOCTL_STORAGE_MCN_CONTROL"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
