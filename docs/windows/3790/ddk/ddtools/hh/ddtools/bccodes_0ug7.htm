<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>Bug Check 0x7F:  UNEXPECTED_KERNEL_MODE_TRAP</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="bug check 0x7F">
<META NAME="MS-HKWD" CONTENT="UNEXPECTED_KERNEL_MODE_TRAP">
</HEAD>
<BODY TOPMARGIN="0">

<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Driver&nbsp;Development&nbsp;Tools:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H1><A NAME="ddk_bug_check_0x7f_bug"></A>Bug Check 0x7F: UNEXPECTED_KERNEL_MODE_TRAP</H1>

<P>The UNEXPECTED_KERNEL_MODE_TRAP bug check has a value of 0x0000007F. This indicates that a trap was generated by the Intel CPU and the kernel failed to catch this trap.</P>

<P>This could be either a <I>bound trap </I>(a trap the kernel is not permitted to catch) or a <I>double fault </I>(a fault that occurred while processing an earlier fault, which always results in a system crash).</P>

<H4>Parameters</H4>

<P>The first parameter displayed on the blue screen specifies the trap number.</P>

<P>Here are some of the most common trap codes: 

<UL>
	<LI>0x00000000, or Divide by Zero Error, is caused when a DIV instruction is executed and the divisor is zero. Memory corruption, other hardware problems, or software failures can cause this error. </LI>

	<LI>0x00000004, or Overflow, occurs when the processor executes a call to an interrupt handler when the overflow (OF) flag is set. </LI>

	<LI>0x00000005, or Bounds Check Fault, is generated when the processor, while executing a BOUND instruction, finds the operand exceeds the specified limits. A BOUND instruction is used to ensure that a signed array index is within a certain range. </LI>

	<LI>0x00000006, or Invalid Opcode, is generated when the processor attempts to execute an invalid instruction. This is generally caused when the instruction pointer has become corrupted and is pointing to the wrong location. The most common cause of this is hardware memory corruption. </LI>

	<LI>0x00000008, or Double Fault, is when an exception occurs while trying to call the handler for a prior exception. Normally, the two exceptions can be handled serially. However, there are several exceptions that cannot be handled serially, and in this situation the processor signals a double fault. There are two common causes of a double fault:
<OL>
	<LI>A kernel stack overflow. This occurs when a guard page is hit, and then the kernel tries to push a trap frame. Since there is no stack left, a stack overflow results, causing the double fault. If you suspect this has occurred, use the <B>!thread</B> debugger extension to determine the stack limits, and then use the <B>KB&nbsp;(Display Stack Backtrace)</B> debugger command with a large parameter (for example, <B>kb&nbsp;100</B>) to display the full stack.</LI>

	<LI>A hardware problem.</LI>
</OL>
</LI>
</UL>

<P>The less-common trap codes include:

<UL>
	<LI>0x00000001 — A system-debugger call</LI>

	<LI>0x00000003 — A debugger breakpoint</LI>

	<LI>0x00000007 — A hardware coprocessor instruction with no coprocessor present</LI>

	<LI>0x0000000A — A corrupted Task State Segment</LI>

	<LI>0x0000000B — An access to a memory segment that was not present</LI>

	<LI>0x0000000C — An access to memory beyond the limits of a stack</LI>

	<LI>0x0000000D — An exception not covered by some other exception; a protection fault that pertains to access violations for applications</LI>
</UL>

<P>For other trap numbers, consult an Intel architecture manual.</P>

<H4>Cause</H4>

<P>Bug check 0x7F usually occurs after the installation of faulty or mismatched hardware (especially memory) or in the event that installed hardware fails.</P>

<P>A double fault can occur when the kernel stack overflows. This can happen if multiple drivers are attached to the same stack. For example, two file system filter drivers can be attached to the same stack and then the file system can recurse back in, overflowing the stack.</P>

<H4>Resolving the Problem</H4>

<P><I>Debugging:</I>  Always begin with the <B>!analyze</B> debugger extension.</P>

<P>If this is not sufficient, use the <B>KV&nbsp;(Display Stack Backtrace)</B> debugger command.

<UL>
	<LI>If <B>KV</B> shows a <B>taskGate</B>, then use the <B>.tss&nbsp;(Display Task State Segment)</B> command on the part before the colon.</LI>

	<LI>If <B>KV</B> shows a trap frame, then use the <B>.trap&nbsp;(Display Trap Frame)</B> command to format the frame.</LI>

	<LI>Otherwise, use the <B>.trap&nbsp;(Display Trap Frame)</B> command on the appropriate frame. (On x86 platforms, this frame is associated with the procedure <B>NT!KiTrap</B>.) </LI>
</UL>

<P>After this, use <B>KV</B> again to display the new stack.</P>

<P><I>Troubleshooting: </I>If hardware was recently added to the system, remove it to see if the error recurs. If existing hardware has failed, remove or replace the faulty component. Run hardware diagnostics supplied by the system manufacturer, to determine which hardware component has failed. The memory scanner is especially important; faulty or mismatched memory can cause this bug check. For details on these procedures, see the owner’s manual for your computer. Check that all adapter cards in the computer are properly seated. Use an ink eraser or an electrical contact treatment, available at electronics supply stores, to ensure adapter card contacts are clean. </P>

<P>If the error appears on a newly installed system, check the availability of updates for the BIOS, the SCSI controller or network cards. Updates of this kind are typically available on the Web site or BBS of the hardware manufacturer.</P>

<P>Confirm that all hard disks, hard disk controllers, and SCSI adapters are listed on the Microsoft Windows Hardware Compatibility List (HCL).</P>

<P>If the error occurred after the installation of a new or updated device driver, the driver should be removed or replaced. If, under this circumstance, the error occurs during the startup sequence and the system partition is formatted with NTFS, you might be able to use Safe Mode to rename or delete the faulty driver. If the driver is used as part of the system startup process in Safe Mode, you need to start the computer using the Recovery Console in order to access the file.  Also try restarting your computer, and press F8 at the character-based menu that displays the operating system choices. At the resulting Windows <B>Advanced Options</B> menu, choose the <B>Last Known Good Configuration</B> option. This option is most effective when only one driver or service is added at a time.</P>

<P>Overclocking (setting the CPU to run at speeds above the rated specification) can cause this error. If this has been done to the computer experiencing the error, return the CPU to the default clock speed setting.</P>

<P>Check the System Log in Event Viewer for additional error messages that might help pinpoint the device or driver that is causing the error. Disabling memory caching of the BIOS might also resolve it. </P>

<P>If you encountered this error while upgrading to a new version of Windows, it might be caused by a device driver, a system service, a virus scanner, or a backup tool that is incompatible with the new version. If possible, remove all third-party device drivers and system services and disable any virus scanners prior to upgrading. Contact the software manufacturer to obtain updates of these tools. Also make sure that you have installed the latest Windows Service Pack.</P>

<P>Finally, if all the above steps fail to resolve the error, take the system motherboard to a repair facility for diagnostic testing. A crack, a scratched trace, or a defective component on the motherboard can also cause this error.</P>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: Bug%20Check%200x7F:%20%20UNEXPECTED_KERNEL_MODE_TRAP"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
