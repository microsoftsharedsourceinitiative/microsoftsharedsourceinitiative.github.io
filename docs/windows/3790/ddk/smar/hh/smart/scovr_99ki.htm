<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>WDM Reader Driver</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT><META NAME="MS-HKWD" CONTENT="WDM Reader Driver">
</HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_driverentry_kr">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_adddevice_kr">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_unload_kr">
</OBJECT>
<OBJECT ID="hhobj_4" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchcreate_kr">
</OBJECT>
<OBJECT ID="hhobj_5" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchclose_kr">
</OBJECT>
<OBJECT ID="hhobj_6" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_create_kr">
</OBJECT>
<OBJECT ID="hhobj_7" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_close_kr">
</OBJECT>
<OBJECT ID="hhobj_8" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_create_kr">
</OBJECT>
<OBJECT ID="hhobj_9" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_close_kr">
</OBJECT>
<OBJECT ID="hhobj_10" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchcleanup_kr">
</OBJECT>
<OBJECT ID="hhobj_11" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_cleanup_kr">
</OBJECT>
<OBJECT ID="hhobj_12" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchpnp_kr">
</OBJECT>
<OBJECT ID="hhobj_13" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_pnp_kr">
</OBJECT>
<OBJECT ID="hhobj_14" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchpower_kr">
</OBJECT>
<OBJECT ID="hhobj_15" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_power_kr">
</OBJECT>
<OBJECT ID="hhobj_16" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_dispatchdevicecontrol_kr">
</OBJECT>
<OBJECT ID="hhobj_17" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_irp_mj_device_control_kr">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Smart&nbsp;Card&nbsp;Devices:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H2><A NAME="_ntovr_wdm_reader_driver"></A>WDM Reader Driver</H2>

<P>The following table lists the routines required by a WDM reader driver and indicates which library functions the driver routine calls. </P>

<TABLE>

<TR VALIGN="top">
<TH align=left width=29%>Routine</TH>
<TH align=left width=71%>Action Taken in the Routine</TH>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_1.Click()"><B>DriverEntry</B></A></TD>
<TD width=71%>Initializes the driver object and the dispatch table. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_2.Click()"><I>AddDevice</I></A></TD>
<TD width=71%>Creates a device object for the smart card reader. In addition, <I>AddDevice</I> can call any of the following driver library routines:
<UL>
	<LI><A HREF="scfuncw_2xsv.htm"><B>SmartcardInitialize</B> (WDM)</A> to complete driver initialization. Calling this routine in <I>AddDevice</I> is obligatory. </LI>

	<LI><A HREF="scfuncw_2bkv.htm"><B>SmartcardLogError</B>_(WDM)</A> to log an error. Drivers must call this routine in <I>AddDevice</I> if <B>SmartcardInitialize</B> fails. </LI>

	<LI><A HREF="scfuncw_9b8f.htm"><B>SmartcardCreateLink (WDM)</B></A> to create a symbolic link for the reader device in the registry. </LI>
</UL>
</TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_3.Click()"><I>Unload</I></A></TD>
<TD width=71%>Removes the driver from the system. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_4.Click()"><I>DispatchCreate</I></A><B> / </B><A HREF="JavaScript:hhobj_5.Click()"><I>DispatchClose</I></A></TD>
<TD width=71%>Supports <A HREF="JavaScript:hhobj_6.Click()">IRP_MJ_CREATE</A> and <A HREF="JavaScript:hhobj_7.Click()">IRP_MJ_CLOSE</A>. The resource manager sends <A HREF="JavaScript:hhobj_8.Click()">IRP_MJ_CREATE</A> to the reader driver, in order to establish a connection to the reader. It sends <A HREF="JavaScript:hhobj_9.Click()">IRP_MJ_CLOSE</A> in order to sever the connection. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_10.Click()"><I>DispatchCleanup</I></A></TD>
<TD width=71%>Supports <A HREF="JavaScript:hhobj_11.Click()">IRP_MJ_CLEANUP</A>. The resource manager sends IRP_MJ_CLEANUP to the reader driver, in order to cancel pending I/O requests. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_12.Click()"><I>DispatchPnP</I></A> </TD>
<TD width=71%>Supports <A HREF="JavaScript:hhobj_13.Click()">IRP_MJ_PNP</A>. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_14.Click()"><I>DispatchPower</I></A> </TD>
<TD width=71%>Supports <A HREF="JavaScript:hhobj_15.Click()">IRP_MJ_POWER</A>. </TD>
</TR>

<TR VALIGN="top">
<TD width=29%><A HREF="JavaScript:hhobj_16.Click()"><I>DispatchDeviceControl</I></A>. </TD>
<TD width=71%>Supports <A HREF="JavaScript:hhobj_17.Click()">IRP_MJ_DEVICE_CONTROL</A>. This is the main entry point for smart card requests. Upon receiving IRP_MJ_DEVICE_CONTROL, <I>DispatchDeviceControl</I> must immediately call <A HREF="scfuncw_3s7z.htm"><B>SmartcardDeviceControl</B> (WDM)</A>, the smart card driver library routine that handles device control requests. The following is a code snippet that illustrates how to call this library routine in a WDM driver:
<PRE>NTSTATUS
DriverDeviceControl(
    PDEVICE_OBJECT DeviceObject,
    PIRP Irp
    )
{
    PDEVICE_EXTENSION deviceExtension = DeviceObject -&gt; DeviceExtension;

    return SmartcardDeviceControl(
        &amp;(deviceExtension-&gt;SmartcardExtension),
        Irp
        );
}</PRE>

<P>If <B>SmartcardDeviceControl</B> is unable to handle the particular IOCTL indicated in the call, it will call the driver's callback for unknown IOCTL codes. </P>
</TD>
</TR>
</TABLE><BR>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: WDM%20Reader%20Driver"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
