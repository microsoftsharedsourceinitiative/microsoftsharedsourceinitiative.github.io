<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML DIR="LTR"><HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=Windows-1252">
<TITLE>Generating Skipped Macroblocks</TITLE>
<SCRIPT SRC="../scripts/linkcss.js"></SCRIPT><SCRIPT SRC="../scripts/langref.js"></SCRIPT></HEAD>
<BODY TOPMARGIN="0">
<DIV STYLE="display:none;">
<OBJECT ID="hhobj_1" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_p_picture_kg_gly">
</OBJECT>
<OBJECT ID="hhobj_2" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_b_picture_kg_gly">
</OBJECT>
<OBJECT ID="hhobj_3" TYPE="application/x-oleobject" CLASSID="clsid:adb880a6-d8ff-11cf-9377-00aa003b7a11">
	<PARAM NAME="Command" VALUE="ALink,MENU">
	<PARAM NAME="DefaultTopic" VALUE="../notopic_0pk4.htm">
	<PARAM NAME="Item1" VALUE="">
	<PARAM NAME="Item2" VALUE="ddk_obmc_kg_gly">
</OBJECT>
</DIV>


<TABLE CLASS="buttonbarshade" CELLSPACING=0><TR><TD>&nbsp;</TD></TR></TABLE>
<TABLE CLASS="buttonbartable" CELLSPACING=0>
<TR ID="hdr"><TD CLASS="runninghead" NOWRAP>Display&nbsp;and&nbsp;Print&nbsp;Devices:&nbsp;Windows&nbsp;DDK</TD></TR>
</TABLE>
<H4><A NAME="ddk_generating_skipped_macroblocks_gg"></A>Generating Skipped Macroblocks</H4>

<P>The generation of a skipped macroblock in DirectX VA differs somewhat from that in MPEG-2 Video Section 7.6.6. In DirectX VA skipped macroblocks are generated in a separate macroblock control command, rather than being inferred from the type of the preceding nonskipped macroblock and the type of picture displayed (for example, in MPEG-2, the method of generating skipped macroblocks depends on whether the picture is a <A HREF="JavaScript:hhobj_1.Click()">P picture</A> or <A HREF="JavaScript:hhobj_2.Click()">B picture</A>.)</P>

<P>The following conditions are required when generating and using skipped macroblocks:

<UL>
	<LI>Skipped macroblocks have no residual differences.</LI>

	<LI>Skipped macroblocks can be generated by repeating the operation of a macroblock control command with an incremented <B>wMBaddress</B>. (Each subsequent skipped macroblock is generated in the same way as the first, except for incrementing the value of <B>wMBaddress</B>.)</LI>

	<LI>Macroblock skipping is restricted from wrapping to a new row of macroblocks in the picture. (A separate macroblock control command must be sent to generate the first macroblock of each row of macroblocks.)</LI>

	<LI>The content of a macroblock control command with a nonzero value for <I>MBskipsFollowing</I> is equivalent (except for the value of <I>MBskipsFollowing</I>) to the content of an explicit specification of the first of the series of skipped macroblocks. Thus, whenever <I>MBskipsFollowing</I> is not zero, the following structure members and variables must all be equal to zero: <I>Motion4MV, IntraMacroblock, </I><B>wPatternCode</B><I>, and </I><B>wPC_Overflow</B>.</LI>
</UL>

<P>Because of the first three preceding conditions, an accelerator may implement motion compensation (when <I>Motion4MV</I> is zero) by applying the specified motion vectors to a rectangle of width equal to the following expression in the luminance component, and to a similarly specified rectangle in the chrominance components. This rectangular-area motion compensation method can be performed by the accelerator rather than by using <I>MBskipsFollowing</I>+1 repetitions of the same macroblock control operation. </P>

<PRE>(<B>bMacroblockWidthMinus1</B>+1) X (<I>MBskipsFollowing</I>+1)
</PRE>

<P>The <B>bMacroblockWidthMinus1</B> member is contained in <A HREF="dxvaref_9oyv.htm">DXVA_PictureParameters</A>. The <I>MBskipsFollowing</I> variable is in the <B>wMBtype</B> member of each macroblock control structure.</P>

<H4>Skipped Macroblocks in H.263 (Annex F)</H4>

<P>The generation of skipped macroblocks in H.263 with advanced prediction mode active (Annex F), requires representing some skipped macroblocks as nonskipped macroblocks in DirectX VA macroblock control commands. This is done in order to generate the <A HREF="JavaScript:hhobj_3.Click()">OBMC</A> effect within these macroblocks.</P>

<H4>Generating Skipped Macroblocks in MPEG-2 Example</H4>

<P>The following example shows how macroblock control commands are used when skipped macroblocks are generated. For demonstration purposes, assume that in an MPEG-2 bitstream seven macroblocks are used in the following manner. </P>

<TABLE>

<TR VALIGN="top">
<TH align=left width=40%>Macroblock Number</TH>
<TH align=left width=60%>Description</TH>
</TR>

<TR VALIGN="top">
<TD width=40%>0</TD>
<TD width=60%>Coded with a residual difference</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>1</TD>
<TD width=60%>Skipped</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>2</TD>
<TD width=60%>Coded with a residual difference</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>3</TD>
<TD width=60%>Skipped</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>4</TD>
<TD width=60%>Skipped</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>5</TD>
<TD width=60%>Skipped</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>6</TD>
<TD width=60%>Coded with a residual difference</TD>
</TR>
</TABLE><BR>

<P>These seven macroblocks would require the generation (at least) of the five DirectX VA macroblock control commands shown in the following table. The <I>MBskipsFollowing </I>variable indicates the number of skipped macroblocks. The <B>wMBaddress</B> member indicates the address of the macroblock. <I>MBskipsFollowing </I>and <B>wMBaddress</B> are contained in the <A HREF="dxvaref_4rl3.htm">DXVA_MBctrl_P_OffHostIDCT_1</A>, and <A HREF="dxvaref_9t0n.htm">DXVA_MBctrl_P_HostResidDiff_1</A> structures. (The <I>MBskipsFollowing </I>variable is defined in the <B>dwMB_SNL</B> structure member.)</P>

<TABLE>

<TR VALIGN="top">
<TH align=left width=40%>Macroblock Command</TH>
<TH align=left width=60%>Member Values</TH>
</TR>

<TR VALIGN="top">
<TD width=40%>First</TD>
<TD width=60%><B>wMBaddress</B> = 0
<P><I>MBskipsFollowing</I> = 0</P>
</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>Second</TD>
<TD width=60%><B>wMBaddress</B> = 1
<P><I>MBskipsFollowing</I> = 0</P>
</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>Third</TD>
<TD width=60%><B>wMBaddress</B> = 2
<P><I>MBskipsFollowing</I> = 0</P>
</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>Fourth</TD>
<TD width=60%><B>wMBaddress</B> = 3
<P><I>MBskipsFollowing</I> = 2</P>
</TD>
</TR>

<TR VALIGN="top">
<TD width=40%>Fifth</TD>
<TD width=60%><B>wMBaddress</B> = 6
<P><I>MBskipsFollowing</I> = 0</P>
</TD>
</TR>
</TABLE><BR>
<DIV CLASS="footer"><A HREF="mailto:ddksurv1@microsoft.com?subject=DDK Topic Feedback&body=Build date: Thursday, January 16, 2003     Topic Title: Generating%20Skipped%20Macroblocks"> Send feedback on this topic.</A> / Built on Thursday, January 16, 2003 </DIV>
</BODY>
</HTML>
